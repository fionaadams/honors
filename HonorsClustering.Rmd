---
title: "HonorsClustering"
author: "Fiona Adams"
date: "9/26/2019"
output: html_document
---

#cleaning interviews
#function to convert word docs to text files?
#google docs package for R
Resources:
http://www.mjdenny.com/Text_Processing_In_R.html
```{r}
library(readr)
library(stringr)
library(tidyverse)
library(udpipe)
library(corpus)
```

```{r}
AndrewTuttle <- read_delim("AndrewTuttle.txt", 
    "^", escape_double = FALSE, trim_ws = TRUE, col_names=FALSE)
MarvinSeppala <- read_delim("MarvinSeppalaPart1.txt", 
    "^", escape_double = FALSE, trim_ws = TRUE, col_names=FALSE)
ud_model <- udpipe_download_model(language = "english")
udmodel_english <- udpipe_load_model(ud_model$file_model)
```

```{r}
#get rid of the "c(""
cleaninterview <- function(interview) {
  interview %>% 
  tolower() %>%
  str_replace_all("ms.", "miss") %>%
  str_split("\\. | \\? | \\! ") %>%
  as.data.frame()
}

#This doesn't work :( Can't do it in dplyr either! Help!!
changecolname <- function(interview) {
  colnames(interview)[1] <- "sentences"
  interview$sentences <- as.character(interview$sentences)
  interview
}

#Workaround -- done manually for each interview
CleanTuttle <- cleaninterview(AndrewTuttle)
CleanTuttle <- changecolname(CleanTuttle)
# CleanTuttle[[1]] <- as.character(CleanTuttle[[1]])

CleanSeppala <- cleaninterview(MarvinSeppala)
CleanSeppala <- changecolname(CleanSeppala)
# CleanSeppala[[1]] <- as.character(CleanSeppala[[1]])
```

*Goal: find words that match either in idea or substance across multiple interviews*
```{r}
#Gets phrases in df form
#Alphabetize based on function below here!
getkeyphrasessep <- function(interview){
  s <- udpipe_annotate(udmodel_english, interview[[1]])
  x <- data.frame(s)
  phrases <- keywords_rake(x = x, term = "lemma", group = "doc_id", 
                       relevant = x$upos %in% c("NOUN", "ADJ"))
  phrases$key <- factor(phrases$keyword, levels = rev(phrases$keyword))
  top25phrases <- head(phrases$key, 25)
  stemmedphrases <- text_tokens(top25phrases, stemmer = "en")
  listofphrases <- lapply(stemmedphrases, function(x){
  paste(x, collapse=" ")
  })
  dfphrases <- data.frame(theme = unlist(listofphrases))
  return(dfphrases)
}

tuttlephraselist <- getkeyphrasessep(CleanTuttle)
seppalaphraselist <- getkeyphrasessep(CleanSeppala)
tuttlephraselist
seppalaphraselist
tuttlephraselist %in% seppalaphraselist
```

```{r}
library(plyr)

#Gets phrases in alphabetized dataframe form
getkeyphrasesdf <- function(interview){
  s <- udpipe_annotate(udmodel_english, interview[[1]])
  x <- data.frame(s)
  phrases <- keywords_rake(x = x, term = "lemma", group = "doc_id", 
                       relevant = x$upos %in% c("NOUN", "ADJ"))
  phrases$key <- factor(phrases$keyword, levels = rev(phrases$keyword))
  top25phrases <- head(phrases$key, 25)
  stemmedphrases <- text_tokens(top25phrases, stemmer = "en")
  final <- do.call("rbind", list(stemmedphrases[[1]], stemmedphrases[[2]], stemmedphrases[[3]],    stemmedphrases[[4]], stemmedphrases[[5]], stemmedphrases[[6]], stemmedphrases[[7]], stemmedphrases[[8]], stemmedphrases[[9]], stemmedphrases[[10]])) %>% 
    as.data.frame() %>% 
    mutate(phrases = paste(V1, " ", V2)) %>%
    select(phrases) %>%
    aaply(1,sort) %>%
    as.data.frame() %>%
    t() %>%
    as.data.frame() %>%
    mutate(V1=as.character(V1))
  return(final)
}

tuttlephrasedf <- getkeyphrasesdf(CleanTuttle)
seppalaphrasedf <- getkeyphrasesdf(CleanSeppala)

tuttlephrasedf
seppalaphrasedf
```

#Need partial string matching because stemmed words, ex. medic school

```{r}
y<- c("I am looking for a dog", "looking for a new dog", "a dog", "I am just looking")
grep("looking.*dog",y, value=T)
```

```{r}
pmatch("swiss institute", CleanTuttle$sentences, duplicates.ok=TRUE)
as.data.frame(grepl(firstphrase, CleanTuttle$sentences))
#test whether any are 
any(dftest[[1]])
as.data.frame(str_detect(CleanTuttle$sentences, firstphrase))
```

Ideas to complete:
• Get these for other interviews--treat these as broad themes, partial string matching between interviews -- distance between strings using stringr, ex. disabled vs disability (get the root of the word--stemming!) Stem top phrases, and in theory the stemmed version should be the same. 
• CRAN task view nlp, RWeka? See when last updated
• perhaps? Get words from Amy, map those to words that are related ex. education --> med school, grade school, first grade
• Use these phrases to create variables, str_count how many times a phrase is within a sentence
• How to make a new column for each keyword, automatically??
• Can make a column indicating whether the sentence has a word, but not more than that

Try at a later date: 
https://cran.r-project.org/web/packages/textmineR/vignettes/b_document_clustering.html
https://cran.r-project.org/web/packages/tidytext/vignettes/tf_idf.html
https://cran.r-project.org/web/packages/corpus/vignettes/stemmer.html




