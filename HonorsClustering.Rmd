---
title: "HonorsClustering"
author: "Fiona Adams"
date: "9/26/2019"
output: html_document
---
Resources:
http://www.mjdenny.com/Text_Processing_In_R.html
```{r}
library(readr)
library(stringr)
library(tidyverse)
library(udpipe)
library(corpus)
```

```{r}
AndrewTuttle <- read_delim("AndrewTuttle.txt", 
    "^", escape_double = FALSE, trim_ws = TRUE, col_names=FALSE)
MarvinSeppala <- read_delim("MarvinSeppalaPart1.txt", 
    "^", escape_double = FALSE, trim_ws = TRUE, col_names=FALSE)
ud_model <- udpipe_download_model(language = "english")
udmodel_english <- udpipe_load_model(ud_model$file_model)
```

```{r}
cleaninterview <- function(interview) {
  interview %>% 
  tolower() %>%
  str_replace_all("ms.", "miss") %>%
  str_split("\\. | \\? | \\! ") %>%
  as.data.frame()
}

cleaninterviewbyword <- function(interview) {
  interview %>% 
  tolower() %>%
  str_replace_all("[^a-zA-Z\\s]", " ") %>% #Remove all punctuation 
  str_replace_all("[\\s]+", " ") %>% #Shrink to one white space
  str_extract_all("\\w{3,}") %>% #get rid of one or two letter words ex. i, or
  as.data.frame()
}

#This doesn't work :( Can't do it in dplyr either! Help!!
changecolname <- function(interview) {
  colnames(interview)[1] <- "sentences"
  interview$sentences <- as.character(interview$sentences)
}

#Workaround -- done manually for each interview
CleanTuttle <- cleaninterview(AndrewTuttle)
CleanTuttle[[1]] <- as.character(CleanTuttle[[1]])

CleanSeppala <- cleaninterview(MarvinSeppala)
CleanSeppala[[1]] <- as.character(CleanSeppala[[1]])
```

```{r}
#Gets phrases in list form
getkeyphrases <- function(interview){
  s <- udpipe_annotate(udmodel_english, interview[[1]])
  x <- data.frame(s)
  phrases <- keywords_rake(x = x, term = "lemma", group = "doc_id", 
                       relevant = x$upos %in% c("NOUN", "ADJ"))
  phrases$key <- factor(phrases$keyword, levels = rev(phrases$keyword))
  top25phrases <- head(phrases$key, 25)
  stemmedphrases <- text_tokens(top25phrases, stemmer = "en")

  #need help on for loop :(
  # for (i in 1:25) {
  # do.call("rbind", list(stemmedphrases[[i]], stemmedphrases[[i+1]]))
  # }
  
  #Workaround: manually bind top 10 phrases
  final <- do.call("rbind", list(stemmedphrases[[1]], stemmedphrases[[2]], stemmedphrases[[3]],    stemmedphrases[[4]], stemmedphrases[[5]], stemmedphrases[[6]], stemmedphrases[[7]], stemmedphrases[[8]], stemmedphrases[[9]], stemmedphrases[[10]])) %>% 
    as.data.frame() %>% 
    mutate(phrases = paste(V1, " ", V2)) %>%
    select(phrases) %>%
    as.list()
  return(final)
}

bindphrases <- function(interview1, interview2){
  cbind(interview1, interview2)
}

tuttlephrases <- getkeyphrases(CleanTuttle)
seppalaphrases <- getkeyphrases(CleanSeppala)
```

Getting string distance: some first tries

*Goal: find words that match either in idea or substance across multiple interviews*
```{r}
#Gets phrases in separate word form
getkeyphrasessep <- function(interview){
  s <- udpipe_annotate(udmodel_english, interview[[1]])
  x <- data.frame(s)
  phrases <- keywords_rake(x = x, term = "lemma", group = "doc_id", 
                       relevant = x$upos %in% c("NOUN", "ADJ"))
  phrases$key <- factor(phrases$keyword, levels = rev(phrases$keyword))
  top25phrases <- head(phrases$key, 25)
  stemmedphrases <- text_tokens(top25phrases, stemmer = "en")
  return(stemmedphrases)
}

tuttlephraselist <- getkeyphrasessep(CleanTuttle)
seppalaphraselist <- getkeyphrasessep(CleanSeppala)

tuttlephraselist %in% seppalaphraselist
```

```{r}
library(plyr)

#Gets phrases in alphabetized dataframe form
getkeyphrasesdf <- function(interview){
  s <- udpipe_annotate(udmodel_english, interview[[1]])
  x <- data.frame(s)
  phrases <- keywords_rake(x = x, term = "lemma", group = "doc_id", 
                       relevant = x$upos %in% c("NOUN", "ADJ"))
  phrases$key <- factor(phrases$keyword, levels = rev(phrases$keyword))
  top25phrases <- head(phrases$key, 25)
  stemmedphrases <- text_tokens(top25phrases, stemmer = "en")
  final <- do.call("rbind", list(stemmedphrases[[1]], stemmedphrases[[2]], stemmedphrases[[3]],    stemmedphrases[[4]], stemmedphrases[[5]], stemmedphrases[[6]], stemmedphrases[[7]], stemmedphrases[[8]], stemmedphrases[[9]], stemmedphrases[[10]])) %>% 
    as.data.frame() %>% 
    mutate(phrases = paste(V1, " ", V2)) %>%
    select(phrases) %>%
    aaply(1,sort) %>%
    as.data.frame() %>%
    t() %>%
    as.data.frame() %>%
    mutate(V1=as.character(V1))
  return(final)
}

tuttlephrasedf <- getkeyphrasesdf(CleanTuttle)
seppalaphrasedf <- getkeyphrasesdf(CleanSeppala)

tuttlephrasedf
seppalaphrasedf
```

```{r}
#https://www.rdocumentation.org/packages/DescTools/versions/0.99.29/topics/StrDist
library(DescTools)
StrDist(tuttlephrasedf[[1]], seppalaphrasedf[[1]], method = "levenshtein", mismatch = 1, gap = 1, ignore.case = FALSE)
```

```{r}
#https://www.r-bloggers.com/natural-language-processing-in-r-edit-distance/
tuttlephrasedf[[1]]
seppalaphrasedf[[1]]
adist(tuttlephrasedf[[1]],seppalaphrasedf[[1]])
```

```{r}
colnames(CleanTuttle)[1] <- "sentences"

firstphrase <- tuttlephrases %>% head(1) %>% sapply(as.character)

countuse <- function(phrase, data){
  data %>% summarize(count = sum(grepl(phrase, CleanTuttle[1])))
}

#Counts use of first phrase in first row of cleantuttle
countuse(firstphrase, CleanTuttle)
```


```{r}
as.data.frame(grepl(firstphrase, CleanTuttle$sentences))
as.data.frame(str_detect(CleanTuttle$sentences, firstphrase))
```

Ideas to complete:
• Get these for other interviews--treat these as broad themes, partial string matching between interviews -- distance between strings using stringr, ex. disabled vs disability (get the root of the word--stemming!) Stem top phrases, and in theory the stemmed version should be the same. 
• CRAN task view nlp, RWeka? See when last updated
• perhaps? Get words from Amy, map those to words that are related ex. education --> med school, grade school, first grade
• Use these phrases to create variables, str_count how many times a phrase is within a sentence
• How to make a new column for each keyword, automatically??
• Can make a column indicating whether the sentence has a word, but not more than that

Try at a later date: 
https://cran.r-project.org/web/packages/textmineR/vignettes/b_document_clustering.html
https://cran.r-project.org/web/packages/tidytext/vignettes/tf_idf.html
https://cran.r-project.org/web/packages/corpus/vignettes/stemmer.html




